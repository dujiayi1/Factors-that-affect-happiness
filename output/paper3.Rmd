---
title: "Untitled"
author: "Jiayi Du"
date: "2022/3/17"
output: pdf_document
---

```{r, include=FALSE, echo=FALSE}
library(janitor)
library(tidyverse)

# Load the data dictionary and the raw data and correct the variable names
raw_data <- read_csv("gss.csv")
dict <- read_lines("gss_dict.txt", skip = 18) # skip is because of preamble content
# Now we need the labels because these are the actual responses that we need
labels_raw <- read_file("gss_labels.txt")


#### Set-up the dictionary ####
# What we want is a variable name and a variable definition
variable_descriptions <- as_tibble(dict) %>% 
  filter(value!="}") %>% 
  mutate(value = str_replace(value, ".+%[0-9].*f[ ]{2,}", "")) %>% 
  mutate(value = str_remove_all(value, "\"")) %>% 
  rename(variable_description = value) %>% 
  bind_cols(tibble(variable_name = colnames(raw_data)[-1]))
 
# Now we want a variable name and the possible values
labels_raw_tibble <- as_tibble(str_split(labels_raw, ";")[[1]]) %>% 
  filter(row_number()!=1) %>% 
  mutate(value = str_remove(value, "\nlabel define ")) %>% 
  mutate(value = str_replace(value, "[ ]{2,}", "XXX")) %>% 
  mutate(splits = str_split(value, "XXX")) %>% 
  rowwise() %>% 
  mutate(variable_name = splits[1], cases = splits[2]) %>% 
  mutate(cases = str_replace_all(cases, "\n [ ]{2,}", "")) %>%
  select(variable_name, cases) %>% 
  drop_na()

# Now we have the variable name and the different options e.g. age and 0-9, 10-19, etc.
labels_raw_tibble <- labels_raw_tibble %>% 
  mutate(splits = str_split(cases, "[ ]{0,}\"[ ]{0,}"))

# The function sets up the regex (I know, I know, but eh: https://xkcd.com/208/)
add_cw_text <- function(x, y){
  if(!is.na(as.numeric(x))){
    x_new <- paste0(y, "==", x,"~")
  }
  else{
    x_new <- paste0("\"",x,"\",")
  }
  return(x_new)
}

# The function will be in the row, but it'll get the job done
cw_statements <- labels_raw_tibble %>% 
  rowwise() %>% 
  mutate(splits_with_cw_text = list(modify(splits, add_cw_text, y = variable_name))) %>% 
  mutate(cw_statement = paste(splits_with_cw_text, collapse = "")) %>% 
  mutate(cw_statement = paste0("case_when(", cw_statement,"TRUE~\"NA\")")) %>% 
  mutate(cw_statement = str_replace(cw_statement, ",\"\",",",")) %>% 
  select(variable_name, cw_statement)
# So for every variable we now have a case_when() statement that will convert 
# from the number to the actual response.

# Just do some finally cleanup of the regex.
cw_statements <- 
  cw_statements %>% 
  mutate(variable_name = str_remove_all(variable_name, "\\r")) %>% 
  mutate(cw_statement = str_remove_all(cw_statement, "\\r"))


#### Apply that dictionary to the raw data ####
# Pull out a bunch of variables and then apply the case when statement for the categorical variables
gss <- raw_data %>% 
  select(CASEID, 
         agedc, 
         achd_1c, 
         achdmpl, 
         totchdc, 
         acu0c,
         agema1c,
         achb1c,
         rsh_131a,
         arretwk,
         slm_01, 
         sex, 
         brthcan, 
         brthfcan,
         brthmcan,
         brthmacr,
         brthprvc,
         yrarri,
         prv, 
         region, 
         luc_rst, 
         marstat, 
         amb_01, 
         vismin, 
         alndimmg,
         bpr_16, 
         bpr_19,
         ehg3_01b, 
         odr_10, 
         livarr12, 
         dwelc, 
         hsdsizec,
         brthpcan,
         brtpprvc, 
         visminpr,
         rsh_125a, 
         eop_200,
         uhw_16gr,
         lmam_01, 
         acmpryr,
         srh_110,
         srh_115,
         religflg, 
         rlr_110,
         lanhome, 
         lan_01,
         famincg2, 
         ttlincg2, 
         noc1610, 
         cc_20_1,
         cc_30_1,
         ccmoc1c,
         cor_031,
         cor_041,
         cu0rnkc,
         pr_cl,
         chh0014c,
         nochricc,
         grndpa,
         gparliv,
         evermar,
         ma0_220,
         nmarevrc,
         ree_02,
         rsh_131b,
         rto_101,
         rto_110,
         rto_120,
         rtw_300,
         sts_410,
         csp_105,
         csp_110a,
         csp_110b,
         csp_110c,
         csp_110d,
         csp_160,
         fi_110) %>% 
  mutate_at(vars(agedc:fi_110), .funs = funs(ifelse(.>=96, NA, .))) %>% 
  mutate_at(.vars = vars(sex:fi_110),
            .funs = funs(eval(parse(text = cw_statements %>%
                                      filter(variable_name==deparse(substitute(.))) %>%
                                      select(cw_statement) %>%
                                      pull()))))


# Fix the names
gss <- gss %>% 
  clean_names() %>% 
  rename(age = agedc,
         age_first_child = achd_1c,
         age_youngest_child_under_6 = achdmpl,
         total_children = totchdc,
         age_start_relationship = acu0c,
         age_at_first_marriage = agema1c,
         age_at_first_birth = achb1c,
         distance_between_houses = rsh_131a,
         age_youngest_child_returned_work = arretwk,
         feelings_life = slm_01,
         sex = sex,
         place_birth_canada = brthcan,
         place_birth_father = brthfcan,
         place_birth_mother = brthmcan,
         place_birth_macro_region = brthmacr,
         place_birth_province = brthprvc,
         year_arrived_canada = yrarri,
         province = prv,
         region = region,
         pop_center = luc_rst,
         marital_status = marstat,
         aboriginal = amb_01,
         vis_minority = vismin,
         age_immigration = alndimmg,
         landed_immigrant = bpr_16,
         citizenship_status = bpr_19,
         education = ehg3_01b,
         own_rent = odr_10,
         living_arrangement = livarr12,
         hh_type = dwelc,
         hh_size = hsdsizec,
         partner_birth_country = brthpcan,
         partner_birth_province = brtpprvc,
         partner_vis_minority = visminpr,
         partner_sex = rsh_125a,
         partner_education = eop_200,
         average_hours_worked = uhw_16gr,
         worked_last_week = lmam_01,
         partner_main_activity = acmpryr,
         self_rated_health = srh_110,
         self_rated_mental_health = srh_115,
         religion_has_affiliation = religflg,
         regilion_importance = rlr_110,
         language_home = lanhome,
         language_knowledge = lan_01,
         income_family = famincg2,
         income_respondent = ttlincg2,
         occupation = noc1610,
         childcare_regular = cc_20_1,
         childcare_type = cc_30_1,
         childcare_monthly_cost = ccmoc1c,
         ever_fathered_child = cor_031,
         ever_given_birth = cor_041,
         number_of_current_union = cu0rnkc,
         lives_with_partner = pr_cl,
         children_in_household = chh0014c,
         number_total_children_intention = nochricc,
         has_grandchildren = grndpa,
         grandparents_still_living = gparliv,
         ever_married = evermar,
         current_marriage_is_first = ma0_220,
         number_marriages = nmarevrc,
         religion_participation = ree_02,
         partner_location_residence = rsh_131b,
         full_part_time_work = rto_101,
         time_off_work_birth = rto_110,
         reason_no_time_off_birth = rto_120,
         returned_same_job = rtw_300,
         satisfied_time_children = sts_410,
         provide_or_receive_fin_supp = csp_105,
         fin_supp_child_supp = csp_110a,
         fin_supp_child_exp = csp_110b,
         fin_supp_lump = csp_110c,
         fin_supp_other = csp_110d,
         fin_supp_agreement = csp_160,
         future_children_intention = fi_110) 


#### Clean up ####
gss <- gss %>% 
  mutate_at(vars(age:future_children_intention), 
            .funs = funs(ifelse(.=="Valid skip"|.=="Refusal"|.=="Not stated", "NA", .))) 

gss <- gss %>% 
  mutate(is_male = ifelse(sex=="Male", 1, 0)) 

gss <- gss %>% 
  mutate_at(vars(fin_supp_child_supp:fin_supp_other), .funs = funs(case_when(
    .=="Yes"~1,
    .=="No"~0,
    .=="NA"~as.numeric(NA)
  )))

main_act <- raw_data %>% 
  mutate(main_activity = case_when(
    mpl_105a=="Yes"~ "Working at a paid job/business",
    mpl_105b=="Yes" ~ "Looking for paid work",
    mpl_105c=="Yes" ~ "Going to school",
    mpl_105d=="Yes" ~ "Caring for children",
    mpl_105e=="Yes" ~ "Household work", 
    mpl_105i=="Yes" ~ "Other", 
    TRUE~ "NA")) %>% 
  select(main_activity) %>% 
  pull()

age_diff <- raw_data %>% 
  select(marstat, aprcu0c, adfgrma0) %>% 
  mutate_at(.vars = vars(aprcu0c:adfgrma0),
            .funs = funs(eval(parse(text = cw_statements %>%
                                      filter(variable_name==deparse(substitute(.))) %>%
                                      select(cw_statement) %>%
                                      pull())))) %>% 
  mutate(age_diff = ifelse(marstat=="Living common-law", aprcu0c, adfgrma0)) %>% 
  mutate_at(vars(age_diff), .funs = funs(ifelse(.=="Valid skip"|.=="Refusal"|.=="Not stated", "NA", .))) %>% 
  select(age_diff) %>% 
  pull()

gss <- gss %>% mutate(main_activity = main_act, age_diff = age_diff)

# Change some from strings into numbers
gss <- gss %>% 
  rowwise() %>% 
  mutate(hh_size = str_remove(string = hh_size, pattern = "\\ .*")) %>% 
  mutate(hh_size = case_when(
    hh_size=="One" ~ 1,
    hh_size=="Two" ~ 2,
    hh_size=="Three" ~ 3,
    hh_size=="Four" ~ 4,
    hh_size=="Five" ~ 5,
    hh_size=="Six" ~ 6
  )) 

gss <- gss %>% 
  rowwise() %>% 
  mutate(self_rated_health = str_remove(string = self_rated_health, pattern = "\\ .*")) %>% 
  mutate(self_rated_health = case_when(
    self_rated_health=="Poor" ~ 1,
    self_rated_health=="Fair" ~ 2,
    self_rated_health=="Good" ~ 3,
    self_rated_health=="Very good" ~ 4,
    self_rated_health=="Excellent" ~ 5,
    self_rated_health=="Valid skip" ~ as.numeric(NA),
    self_rated_health=="Don't know" ~ as.numeric(NA),
    self_rated_health=="Refusal" ~ as.numeric(NA),
    self_rated_health=="Not stated" ~ as.numeric(NA)
  )) 

gss <- gss %>% 
  rowwise() %>% 
  mutate(self_rated_mental_health = str_remove(string = self_rated_mental_health, pattern = "\\ .*")) %>% 
  mutate(self_rated_mental_health = case_when(
    self_rated_mental_health=="Poor" ~ 1,
    self_rated_mental_health=="Fair" ~ 2,
    self_rated_mental_health=="Good" ~ 3,
    self_rated_mental_health=="Very good" ~ 4,
    self_rated_mental_health=="Excellent" ~ 5,
    self_rated_mental_health=="Valid skip" ~ as.numeric(NA),
    self_rated_mental_health=="Don't know" ~ as.numeric(NA),
    self_rated_mental_health=="Refusal" ~ as.numeric(NA),
    self_rated_mental_health=="Not stated" ~ as.numeric(NA)
  )) 

gss <- gss %>% 
  rowwise() %>% 
  mutate(number_marriages = str_remove(string = number_marriages, pattern = "\\ .*")) %>% 
  mutate(number_marriages = case_when(
    number_marriages=="No" ~ 0,
    number_marriages=="One" ~ 1,
    number_marriages=="Two" ~ 2,
    number_marriages=="Three" ~ 3,
    number_marriages=="Four" ~ 4
  )) 

gss <- gss %>% 
  rowwise() %>% 
  mutate(number_total_children_known = ifelse(number_total_children_intention=="Don't know"|number_total_children_intention=="NA", 0, 1)) %>% 
  mutate(number_total_children_intention = str_remove(string = number_total_children_intention, pattern = "\\ .*")) %>% 
  mutate(number_total_children_intention = case_when(
    number_total_children_intention=="None" ~ 0,
    number_total_children_intention=="One" ~ 1,
    number_total_children_intention=="Two" ~ 2,
    number_total_children_intention=="Three" ~ 3,
    number_total_children_intention=="Four" ~ 4,
    number_total_children_intention=="Don't" ~ as.numeric(NA)
  )) 

write_csv(gss, "gss_family.csv")
```

# Introduction
Different aspects of the Canadian society has entered a relatively stable stage in the past few decades, such as its economy and politics. However, it doesn’t mean that the Canadians haven’t been experiencing changes that drastically affect their lifestyles. Factors including social policies and technology advancements have greatly shift the Canadians’ ideology, values, and one of the most common change is their attitude towards marriage. Surveys have shown that more than half of the Canadians see no reasons in getting legally married. They tend to form common low relationships or simply stay single, because from their perspectives, it seemed like marriages are more likely to end up in a mess than happiness.

The General Social Survey(GSS) conducted a survey to Canadians on the topic of Family in 2017. By utilizing the data collected from the survey, this paper aims to explore the different possible factors that affect the happiness of single and married people, such as age, sex, marital status, personal income, average working hours and so on. Then we demonstrate possible concerns of Canadian families… In addition, we will give suggestions to improve their life quality.

In this paper, we are only interested in the respondents who are single or married. We focused on these (number) variables: age, personal income, family income, sex, average working hours and education.
Variable “age” indicates the age of the survey respondents. We restrict the age group to respondents between 18 and 80 years old. Variable “feelings_life” indicates how the respondents generally feel about their life from a scale of 0 to 10. Variable “income_respondent” provides the personal income of the respondents from all possible sources. Variable "income_family" represents the total income of the family. Variable "average_hours_worked" means the weekly working hours of the respondents. Variable "education" provides the education level of respondents. Variable "marital_status" indicates the marital status of respondents, and in this paper we mainly analyzed the respondents of "Married" and "Single, never married". 

# Data

## Background

The survey we utilized in this paper comes from the General Social Survey(GSS) of Canada in 2017. The GSS program, founded in 1985, designed and conducted surveys targeting Canadians and focusing on different aspects of life each year. 

The purpose of those surveys was to collect enough data to investigate potential social issues faced by Canadians, seek for approaches to address these issues, and improve their life quality and personal wellness. This paper selected the GSS in 2017, which focused on the topic of evolution of Families. This questionnaire has a total of 20602 samples and 460 variables. Its target respondents are the 
people who live in Canada who are older than 15.

## Methodology

The survey questions were tested by Statistics Canada's Questionnaire Design Resource Center beforehand. Screened participants from two cities were selected to complete the questionnaire. Base on the feedback of these participants, questions were improved to enhance the effectiveness of the survey. The sampling frame of this survey was created by the Census and Statistics Canada's dwelling frame, The respondents were accessed by landline and cellular telephone numbers, and only one member from each of the selected households 
was asked to fill the questionnaire. Stratified sampling was used to select the respondents. The Canadian population was divided into 27 strata based on the provinces and census metropolitan areas. 

Minimum number of random samples were picked from each of the strata to reduce the bias. Invitation letters were sent to the sampled households prior to the official survey to increase the response rate.


```{r include=FALSE}
gss<-read.csv("gss_family.csv",header=TRUE)
gss<-gss%>%select(age,feelings_life,sex,marital_status,education,average_hours_worked,income_family,income_respondent)
```


```{r, echo=FALSE}
gss<-gss%>%na.omit(gss)
gss<-gss%>%filter(marital_status=="Married"|marital_status=="Single, never married")%>%filter(average_hours_worked!="Don't know")
glimpse(gss)
```

```{r}
library(ggplot2)
ggplot(gss,aes(x=feelings_life,fill=income_family))+geom_histogram(position = position_dodge(0.75),binwidth = 1)+facet_grid(.~marital_status)

```

```{r}
ggplot(gss,aes(x=feelings_life,fill=average_hours_worked))+geom_histogram(position = position_dodge(0.75),binwidth = 1)+facet_grid(.~marital_status)

```

```{r}
ggplot(gss,aes(x=feelings_life,fill=education))+geom_histogram(position = position_dodge(0.75),binwidth = 1)+facet_grid(.~marital_status)
```



```{r}
ggplot(aes(x = age, fill = marital_status), data = gss) +geom_histogram(binwidth = 0.2)+facet_wrap(~feelings_life)
ggplot(aes(x = feelings_life, fill = sex), data = gss) +geom_bar(position = "dodge")+facet_wrap(~marital_status)
```

# Discussion

##Strengths

The response rate of GSS in 2017 is approximately 52.4%, which is a pretty high number. To make sure that the samples were representative of the target population, the survey data were applied by a weighing factor so that the outcome of the survey was more accurate. Confidentiality rules prevented the respondents’ personal information to be disclosed without permission.

##Weaknesses

Some questions which appeared to be quite sensitive to many respondents resulted in high non-response rates. For instance, respondents were generally unwilling to provide information about their incomes. As a result, the information 
about income was acquired by the tax returns filed by the respondents from the previous year, and the variable “income” was set to a categorical variable. 

However, this made the survey data collected much vaguer and less likely to reflect the true statistics of income.
Some bias were associated with the GSS data. For instance, not all target population was covered by the sampling method. The group of households without telephones were not included in the sampled population, which potentially increased the bias of the survey data. Non-response bias was resulted from the group of sampled populations who did not respond to the survey.

